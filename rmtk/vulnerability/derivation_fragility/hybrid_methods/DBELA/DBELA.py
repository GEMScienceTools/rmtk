# -*- coding: utf-8 -*-
import os
import numpy
import math
from scipy import interpolate
from scipy import optimize
import matplotlib.pyplot as plt
from rmtk.vulnerability.common import utils

def calculate_fragility(capacity_curves,gmrs):
    
    no_damage_states = len(damage_model['damage_states'])
    no_gmrs = len(gmrs['time'])
    no_capacity_curves = len(capacity_curves['Sd'])
    PDM = numpy.zeros((no_gmrs,no_damage_states+1))
    for icc in range(no_capacity_curves):
        print str((icc+1)*100/no_capacity_curves) + '%'
        capacity = capacity_curves['Sd'][icc]
        for igmr in range(no_gmrs):
            demand = calculate_demand(gmrs,igmr,capacity_curves,icc)
            PDM = compare_capacity_demand(igmr,PDM,capacity,demand)
            
    return PDM

def calculate_demand(gmrs,igmr,capacity_curves,icc):

    demand = []
    
    Sd = capacity_curves['Sd'][icc]
    Sdy = capacity_curves['Sdy'][icc]
    height = capacity_curves['heights'][icc]
    period = capacity_curves['periods'][icc]
    ductilities = calculate_ductilities(Sd,Sdy)
    equivalent_dampings = calculate_equivalent_damping(ductilities)
    correction_factors = calculate_correction_factors(equivalent_dampings)
    
    time = gmrs['time'][igmr]
    acc = gmrs['acc'][igmr]      
    Sde = utils.NigamJennings(time,acc,[period],equivalent_dampings[0]) 
    
    for factor in correction_factors:
        demand.append(Sde/factor)
    
    return demand

def calculate_ductilities(Sdy,Sds):
	
	ductilities = []
	for Sd in Sds:
        ductilities.append(Sd/Sdy)
	
    return ductilities

def calculate_equivalent_damping(structure_type,ductilities):
	
	equivalent_dampings = []
	if structure_type == 'bare frame' or structure_type == 'infilled frame' :
		for ductility in ductilities:
			equivalent_dampings.append(0.05+0.565*(ductility-1)/(ductility*math.pi))
	
    return equivalent_dampings
    
def calculate_periods(structure_type,ductilities,height):
    
    periods = []
    
    if structure_type == 'bare frame':
        periods.append(0.070*height)

    if structure_type == 'infilled frame':
        if code == "non-ductile":
            periods.append(0.060*height)
        if code == "ductile":
            periods.append(0.042*height)

    periods.append(periods[0]*math.sqrt(ductilities[1]))
    periods.append(periods[0]*math.sqrt(ductilities[2]))
            
    return periods
    
def calculate_correction_factors(dampings):
	
	correction_factors=[]
	for damping in dampings:
		correction_factors.append(math.sqrt(10/(5+damping*100)))

	return correction_factors
    
def compare_capacity_demand(igmr,PDM,capacity,demand):
        
    no_ls = len(capacity)
    PDM[igmr,0]=PDM[igmr,0]+1
    for ils in range(no_ls):
        if demand[ils] > capacity[ils]:
            PDM[igmr,no_ls-ils]=PDM[igmr,no_ls-ils]+1
            PDM[igmr,0]=PDM[igmr,0]-1
            break
