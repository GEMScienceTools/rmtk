source SDOFmodel.tcl;
loadConst -time 0.0
set maxSteps  7805
set dt 0.005

set IDloadTag 400;	# for uniformSupport excitation
set GMfile "grm1.tcl" ;
set GMdirection "1";			# ground-motion direction
set GMfact "1"; 
set AccelSeries "Series -dt $dt -filePath $GMfile -factor  $GMfact";		# time series information
pattern UniformExcitation  $IDloadTag  $GMdirection -accel  $AccelSeries  ;	# create Unifform excitation

# create the analysis
constraints Plain
numberer RCM
system BandSPD
test NormDispIncr 1.0e-8 20
algorithm Newton
integrator Newmark 0.5 0.25
analysis Transient;
set ok 0 
set step 1

while {$ok == 0} {
	set ok [analyze 1 $dt]
	# if the analysis fails try initial tangent iteration 
	if {$ok != 0} { 
	    puts "regular newton failed .. lets try an initail stiffness for this step" 
		test NormDispIncr 1.0e-8 20
	    algorithm ModifiedNewton -initial 
	    set ok [analyze 1 0.01000] 
	    if {$ok == 0} {puts "that worked .. back to regular newton"} 
		test NormDispIncr 1.0e-8 20
	    algorithm Newton 
	}
	set step [expr $step+1]
	if {$step > $maxSteps} { 
	    break
	}
} 

set maxSteps 2000 
set dt 0.005
set IDloadTag 401;	# for uniformSupport excitation
set GMfile "grm0.tcl" ;		# ground-motion filenames, should be different files
set GMdirection "1";			# ground-motion direction
set GMfact "1"; 
set AccelSeries "Series -dt $dt -filePath $GMfile -factor  $GMfact";		# time series information
pattern UniformExcitation  $IDloadTag  $GMdirection -accel  $AccelSeries  ;	# create Unifform excitation

#set ksi 0.1
#set a1 [expr $ksi*2.0/$omega];	# mass damping coefficient based on first and second modes
#rayleigh 0.0 0.0 $a1 0.0;

test NormDispIncr 1.0e-8 20
algorithm Newton
set step 1
while {$ok == 0} { 
	set ok [analyze 1 $dt]
	# if the analysis fails try initial tangent iteration 
	if {$ok != 0} { 
	    puts "regular newton failed .. lets try an initail stiffness for this step" 
		test NormDispIncr 1.0e-8 20
	    algorithm ModifiedNewton -initial 
	    set ok [analyze 1 $dt] 
	    if {$ok == 0} {puts "that worked .. back to regular newton"} 
		test NormDispIncr 1.0e-8 20
	    algorithm Newton 
	} 
	set step [expr $step+1]
	if {$step > $maxSteps} { 
	    break
	}
} 

# SET RECORDERS
 set maxSteps  7560
 set dt 0.005
 set IDloadTag 402;	 
 set GMfile "grm2.tcl" ;
 set GMdirection "1";
 set GMfact "1"; 
 set AccelSeries "Series -dt $dt -filePath $GMfile -factor  $GMfact";	
 pattern UniformExcitation  $IDloadTag  $GMdirection -accel  $AccelSeries  ;

 #set ksi 0.05
 #set betaKcomm [expr $ksi*2.0/$omega]
# rayleigh $alphaM $betaK $betaKinit $betaKcomm

 test NormDispIncr 1.0e-8 20
 algorithm Newton
 set ok 0 
 set step 1
 while {$ok == 0} { 
	 set ok [analyze 1 $dt]
	if {$ok != 0} { 
	    puts "regular newton failed .. lets try an initail stiffness for this step" 
		test NormDispIncr 1.0e-8 20
	    algorithm ModifiedNewton -initial 
	    set ok [analyze 1 0.01000] 
	    if {$ok == 0} {puts "that worked .. back to regular newton"} 
		test NormDispIncr 1.0e-8 20
	    algorithm Newton 
	} 
	 set step [expr $step+1]
	if {$step > $maxSteps} { 
	    break
	}
} 

set outfile [open "dynamicResult2.txt" w]
if {$ok != 0} { 
     puts $outfile "KO" 
     puts "Dynamic Analysis Failed" 
		close $outfile 
}
if {$ok == 0} { 
     puts $outfile "OK" 
     puts "Dynamic Analysis Completed" 
		close $outfile 
}

wipe all 
