clc; clear all
%Input data
addpath('/Users/chiaracasotto/Documents/GEM/RMTK/DimitriosFiles');

Gamma = [1	1	1	1	1];
T = [1.0037	0.77964	0.74098	0.63234	0.48996];
Tav = 0.696;
Sa_ratios = [ 1.6391934   1.22582094  1.11783742  0.92913515  0.72870817];
SPO = [0.099	0.206	0.25	0.25	91.431	91.431	84.659;...
    0.061	0.147	0.29	0.25	63.103	63.103	54.743;...
    0.067	0.130	0.20	0.300	54.735	54.735	45.919;...
    0.065	0.184	0.27	0.27	141.680	141.680	120.290;...
    0.082	0.206	0.3	0.3	111.26	111.26	108.06];
Tc = 0.5;
Td = 1.8;

dlim	= [0.002, 0.005, 0.01, 0.02, 0.04, 0.06, 0.08];
%dlim = [0.046144456, 0.107312842, 0.212491246, 0.473466774, 0.724976013, 0.940278828, 0.940278828];
bUthd	= 0.;
vecs = csvread('../fragility_process/inputs/EDPvec-RDvec.csv');
EDPvec = vecs(:,1);
RDvec = vecs(:,2);

noBlg = 5;
w = [0.1 0.2 0.3 0.3 0.1];
g = 9.81;
MC = 25;

for blg = 1:noBlg
    dry = SPO(blg,1);
    du = SPO(blg,4);
    EDPsample = zeros(1,MC);
    for i = 1:length(dlim)
        [mc,a,ac,r,mf] = get_spo2ida_parameters(SPO(blg,:), T(blg), Gamma(blg));
        [SaT50,bTSa]=DFfragility(dry,dlim(i),bUthd,mc,r,du,T(blg),Gamma(blg),EDPvec,RDvec,Tc,Td,g,MC);
        SS(blg,i) = SaT50;
        SC(blg,i) = bTSa;
        Sa_av = log(SaT50)*Sa_ratios(blg);bSa_av=bTSa*Sa_ratios(blg);
        SaT(blg,i) = Sa_av;
        b(blg,i) = bSa_av;
    end
end

% weighted mean
for blg=1:noBlg
    SaTs(blg,:) = SaT(blg,:)*w(blg);
end
SaT_mean = sum(SaTs);
% weighted st dev
for blg = 1:noBlg
    bTs(blg,:) = ((SaT(blg,:)-SaT_mean).^2+b(blg,:).^2)*w(blg);
end

bT = sum(bTs).^0.5;

xlswrite(horzcat('./results/fragility_process_matlab.xls'),[exp(SaT_mean)' bT'])